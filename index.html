<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>チャット</title>
    <style>
      #inputname{
        display: none;
      }
      #chatwindow{
        display: none;
      }
    </style>
</head>
<body>
  <h1>チャット</h1>

  <section id="nowconnecting">
    ...サーバに接続中
  </section>

  <section id="inputname">
    <form id="inputname-form">
      <p>名前を入力してください</p>
      <input type="text" id="name">
      <button>入室する</button>
    </form>
  </section>

  <section id="chatwindow">
    <form id="chat">
      <span id="myname"></span> さん
      <input type="text" id="message">
      <button>送信</button>
    </form>

    <ul id="message-list">
      <li>メッセージがここに表示されます</li>
    </ul>
  </section>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const IAM = {
      token: null,
      name: null
    }

    const socket = io();
    socket.on("token", (token)=>{
      IAM.token = token;
      console.log("トークンを取得しました", token);

      // トークンを取得したら、名前入力画面を表示する
      document.querySelector("#nowconnecting").style.display = "none";
      document.querySelector("#inputname").style.display = "block";
    });
    socket.on("chatlog", (log)=>{
      console.log(log);
      for(let i=0; i<log.length; i++){
        addChatLog(log[i]);
      }
    });

    document.querySelector("#inputname-form").addEventListener("submit", (e)=>{
      e.preventDefault();
      const name = document.querySelector("#name").value;
      IAM.name = name;

      // 自分自身の名前を表示する
      document.querySelector("#myname").textContent = name;

      // 名前を入力したら、チャット画面を表示する
      document.querySelector("#inputname").style.display = "none";
      document.querySelector("#chatwindow").style.display = "block";
    });

    document.querySelector("#chat").addEventListener("submit", (e) => {
      e.preventDefault();
      const message = document.querySelector("#message").value;
      const data = {
        name: IAM.name,
        message: message,
        token: IAM.token
      };
      socket.emit("post", data);
    });

    socket.on("member-post", (data) => {
      addChatLog(data);
    });

    function addChatLog(data){
      const li = document.createElement("li");
      let color = "black";
      if(data.token === IAM.token){
        color = "red";
      }
      li.innerHTML = `<span style="color:${color}">${data.name}: ${data.message}</span>`
      document.querySelector("#message-list").appendChild(li);
    }
  </script>
</body>
</html>